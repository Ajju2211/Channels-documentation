# Channels-documentation
This is the custom payloads documentation of very channels. 
You can also integrate with third party services such as an NLP tool, through the IDE Bot Builder. As an advanced user, you can have control for custom hosting of your bot using the 'Callback URL' option to specify the endpoint where your bot logic resides.
# Building a bot outside Bot Builder tool.
Gupshup allows you to write the bot code outside Gupshup's Bot Builder tool in any programming language of your choice.You can then associate a callback to the bot on Gupshup's platform.This callback will be the location of your bot code on the server where you have hosted the code. Whenever the bot is called by the user, Gupshup will send the relevant details to your bot through the callback URL using which you can respond back to the user.
1.  Create a bot on Gupshup platform - Go to My Bots section and then click on the '+' sign on the bottom right and give a name to the bot.
2.  Write the bot's code in your IDE -
When a user interacts with the bot a GET call is made to the callback URL with additional parameters
Pseudo code 
*   String URL is url of  is external chatbot api

JSONObject messageobjObj = JSONObject(messageobj)
String conversationType = messageobjObj.getString("type");
String cityName = messageobjObj.getString("text");
if(conversationType.equalsIgnoreCase("msg"))
{
  String URL = "https://api.worldweatheronline.com/free/v2/weather.ashx?q="+cityName+"&format=json&num_of_days=1&key={Your apikey}";

  okhttp3.OkHttpClient client = new okhttp3.OkHttpClient();
  okhttp3.Request request = new okhttp3.Request.Builder()
                              .url(URL)
                              .get()
                              .build();
  okhttp3.Response response = client.newCall(request).execute();
  
  ## immediate response
  In this you return a HTTP response back to the callback without any delay.
  
 * Pseudo code

response.setContentType("text/html"); 
PrintWriter out = response.getWriter();
out.print("Weather in"+cityName+" is -"+responseofWeatherAPI);
out.flush();
out.close();
## Delayed response 
In this you can use the Gupshup send message API.
* Pseudo code

String botname = "weatherbot";
String botmessage = "Weather in"+cityName+" is -"+responseofWeatherAPI";
String URL = "http://api.gupshup.io/sm/api/bot/weatherbot/msg";
String body = "apikey={Your Gupshup API key}&botname="+botname+"&context="+contextobj+"&message="+botmessage;
okhttp3.OkHttpClient client = new okhttp3.OkHttpClient();
okhttp3.MediaType mediaType = MediaType.parse("application/x-www-form-urlencoded");
RequestBody body = RequestBody.create(mediaType,body);
okhttp3.Request request = new okhttp3.Request.Builder()
                           .url(URL)
                           .post(body)
                           .build();
okhttp3.Response response = client.newCall(request).execute();

## Deploy locally and associate the callback
To deploy the bot locally 

## Testing your bot 
You can test your bot either using the Proxy Bots or you can publish your bot to the specific messaging channel and test.


# Set Webhook/Callback URL
* Webhooks handle incoming messages from people who respond to you on WhatsApp including text, location, and media such as pictures and documents as well as the status of the messages you've sent. Callbacks are an important channel to deliver, both timely notifications as well as out-of-band errors, and it is thus highly recommended you set a Webhook URL in the application settings.

* Inbound messages sent by customers to your WhatsApp Business Phone Number will be sent to your webhook URL i.e. customer sends a text message or media attachment on WhatsApp the Gupshup platform registers the event and immediately sends a notification (HTTP POST request) to the Callback URL specified in your application settings.

# Inbound Message and Events
There are several types of inbound notifications that may be delivered to your unique webhook. The set webhook URL for your application receives 3 type of notifications:
* user-event
* message-event
* message

# Inbound payload content type
Content-type: application/json
# Incoming payload body

# Events
1.  user-event : These are generated by our platform when some event occurs. For example, the following system events are received when:
    - A callback URL is set for an app or while using the proxy command to invoke your app on Gupshup Proxy bot phone number(+917834811114) for testing the app
    - An end-user gives consent(Optin) to receive notification from a business phone number.

Sample
{"app":"DemoApp","timestamp":1580227393386,"version":2,"type":"user-event","payload":{"phone":"918x98xx21x4","type":"ABC"}}
* ABC can be sandbox-start/ opted-in/opted-out
* sandbox-start:This event is received when the app is in Sandbox mode and you have set a callback URL
* opted-in: This event is received when an end user opt-in to receive notification from a business
* opted-out	This event is received when an end user opt-out from receiving notification from a business

2. message-event : These events states the status of the message sent using the send message API to WhatsApp API client(which essentially send out message to the customer). 
Sample:
Content type: application/json

{"app":"DemoAPI","timestamp":1580546677791,"version":2,"type":"message-event""payload":{"id":"59f8db90-c37e-4408-90ab-cc54ef8246ad","type":"ABC","destination":"91XX985XX10X","payload":{"whatsappMessageId":"gBEGkYaYVSEEAgkD7bRi9syGnBk","type":"session"}}}

* ABC can be
* enqueued: Message is successfully sent to WhatsApp Business API client
* failed:	Message sent by your business failed to send. Reason for failure will be included in the callback; also see message failure code and reasons table below for further description of the failure.
* sent:	Message was sent to the end-user.
* delivered:	Message sent by your business was delivered to the user's device.
* read:	Message sent by your business was read by the user. 

# Inbound Message
In this section we will understand event: message that you receive on your callback URL. This event states the type of message payload received on your callback URL when a customer sends a message to the registered WhatsApp number.





# Channels-documentation
This is the custom payloads documentation of very channels. 
You can also integrate with third party services such as an NLP tool, through the IDE Bot Builder. As an advanced user, you can have control for custom hosting of your bot using the 'Callback URL' option to specify the endpoint where your bot logic resides.
# Building a bot outside Bot Builder tool.
Gupshup allows you to write the bot code outside Gupshup's Bot Builder tool in any programming language of your choice.You can then associate a callback to the bot on Gupshup's platform.This callback will be the location of your bot code on the server where you have hosted the code. Whenever the bot is called by the user, Gupshup will send the relevant details to your bot through the callback URL using which you can respond back to the user.
1.  Create a bot on Gupshup platform - Go to My Bots section and then click on the '+' sign on the bottom right and give a name to the bot.
2.  Write the bot's code in your IDE -
When a user interacts with the bot a GET call is made to the callback URL with additional parameters
Pseudo code 
*   String URL is url of  is external chatbot api

JSONObject messageobjObj = JSONObject(messageobj)
String conversationType = messageobjObj.getString("type");
String cityName = messageobjObj.getString("text");
if(conversationType.equalsIgnoreCase("msg"))
{
  String URL = "https://api.worldweatheronline.com/free/v2/weather.ashx?q="+cityName+"&format=json&num_of_days=1&key={Your apikey}";

  okhttp3.OkHttpClient client = new okhttp3.OkHttpClient();
  okhttp3.Request request = new okhttp3.Request.Builder()
                              .url(URL)
                              .get()
                              .build();
  okhttp3.Response response = client.newCall(request).execute();
  
  ## immediate response
  In this you return a HTTP response back to the callback without any delay.
  
 * Pseudo code

response.setContentType("text/html"); 
PrintWriter out = response.getWriter();
out.print("Weather in"+cityName+" is -"+responseofWeatherAPI);
out.flush();
out.close();
## Delayed response 
In this you can use the Gupshup send message API.
* Pseudo code

String botname = "weatherbot";
String botmessage = "Weather in"+cityName+" is -"+responseofWeatherAPI";
String URL = "http://api.gupshup.io/sm/api/bot/weatherbot/msg";
String body = "apikey={Your Gupshup API key}&botname="+botname+"&context="+contextobj+"&message="+botmessage;
okhttp3.OkHttpClient client = new okhttp3.OkHttpClient();
okhttp3.MediaType mediaType = MediaType.parse("application/x-www-form-urlencoded");
RequestBody body = RequestBody.create(mediaType,body);
okhttp3.Request request = new okhttp3.Request.Builder()
                           .url(URL)
                           .post(body)
                           .build();
okhttp3.Response response = client.newCall(request).execute();

## Deploy locally and associate the callback
To deploy the bot locally 

## Testing your bot 
You can test your bot either using the Proxy Bots or you can publish your bot to the specific messaging channel and test.


# Set Webhook/Callback URL
* Webhooks handle incoming messages from people who respond to you on WhatsApp including text, location, and media such as pictures and documents as well as the status of the messages you've sent. Callbacks are an important channel to deliver, both timely notifications as well as out-of-band errors, and it is thus highly recommended you set a Webhook URL in the application settings.

* Inbound messages sent by customers to your WhatsApp Business Phone Number will be sent to your webhook URL i.e. customer sends a text message or media attachment on WhatsApp the Gupshup platform registers the event and immediately sends a notification (HTTP POST request) to the Callback URL specified in your application settings.

# Inbound Message and Events
There are several types of inbound notifications that may be delivered to your unique webhook. The set webhook URL for your application receives 3 type of notifications:
* user-event
* message-event
* message

# Inbound payload content type
Content-type: application/json
# Incoming payload body

# Events
1.  **user-event** : These are generated by our platform when some event occurs. For example, the following system events are received when:
    - A callback URL is set for an app or while using the proxy command to invoke your app on Gupshup Proxy bot phone number(+917834811114) for testing the app
    - An end-user gives consent(Optin) to receive notification from a business phone number.

Sample
```{"app":"DemoApp","timestamp":1580227393386,"version":2,"type":"user-event","payload":{"phone":"918x98xx21x4","type":"ABC"}}```
* ABC can be sandbox-start/ opted-in/opted-out
* sandbox-start:This event is received when the app is in Sandbox mode and you have set a callback URL
* opted-in: This event is received when an end user opt-in to receive notification from a business
* opted-out	This event is received when an end user opt-out from receiving notification from a business

2. **message-event** : These events states the status of the message sent using the send message API to WhatsApp API client(which essentially send out message to the customer). 
Sample:
Content type: application/json

```{"app":"DemoAPI","timestamp":1580546677791,"version":2,"type":"message-event""payload":{"id":"59f8db90-c37e-4408-90ab-cc54ef8246ad","type":"ABC","destination":"91XX985XX10X","payload":{"whatsappMessageId":"gBEGkYaYVSEEAgkD7bRi9syGnBk","type":"session"}}}```

* ABC can be
* **enqueued**: Message is successfully sent to WhatsApp Business API client
* **failed**:	Message sent by your business failed to send. Reason for failure will be included in the callback; also see message failure code and reasons table below for further description of the failure.
* **sent**:	Message was sent to the end-user.
* **delivered**:	Message sent by your business was delivered to the user's device.
* read:	Message sent by your business was read by the user. 

3. **Message**
* **Inbound Message**
In this section we will understand event: message that you receive on your callback URL. This event states the type of message payload received on your callback URL when a customer sends a message to the registered WhatsApp number.

##Let us see one by one the types of incoming message received on the Callback URL:
### Text
* Below is a sample payload when a customer sends a text message on WhatsApp to your business number.
Inbound Body:


```
{ "app": "DemoApp",
  "timestamp": 1580227766370,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAhAL3SLAWwHKeKrt6s3FKB0c",
    "source": "918x98xx21x4",
    "type": "text",
    "payload": {
      "text": "Hi"
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    }
  }
}
```



## Customer Replied to a message
Users can respond to a specific message in WhatsApp. For the business to understand the context of a message reply, we include the context object. This context object provides the Gupshup message id(property: gsId) of the message to which the customer replied and the WhatsApp message id(property: id) of the original message.

* Inbound Body
```{
  "app": "DemoApp",
  "timestamp": 1590854464792,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAgo-sMx1DoUoQJRW",
    "source": "918x98xx21x4",
    "type": "text",
    "payload": {
      "text": "hi"
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    },
    "context": {
      "id": "gBEGkYaYVSEEAgnPFrOLcjkFjL8",
      "gsId": "9b71295f-f7af-4c1f-b2b4-31b4a4867bad"
    }
  }
}
```


## Customer clicked on a Quick Reply Button
When your customer clicks on a quick reply button, a response is sent to your Webhook URL. Below is an example of the callback format.
Inbound Body
```
{
  "app": "DemoApp",
  "timestamp": 1590854464792,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAgo-sMx1DoUoQJRW",
    "source": "918x98xx21x4",
    "type": "text",
    "payload": {
      "text": "View Account Balance",
      "type": "button"
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    },
    "context": {
      "id": "gBEGkYaYVSEEAgnPFrOLcjkFjL8",
      "gsId": "9b71295f-f7af-4c1f-b2b4-31b4a4867bad"
    }
  }
}
```

## Image
Below is a sample payload when a customer sends an image along with a caption on WhatsApp to your business number. If no caption is sent, the “caption” key will be missing in the messageObj object.

Inbound Body
```
{
  "app": "DemoApp",
  "timestamp": 1580227895991,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAhAE0dyndiP9cVlr4hC5xU64",
    "source": "918x98xx21x4",
    "type": "image",
    "payload": {
      "caption": "Sample image",
      "url": "https://smapi.gupshup.io/sm/api/wamedia/demobot1/546af999-825e-485b-bf54-4a3323824cca",
      "urlExpiry": 1580832695997
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    }
  }
}
```

## Audio
Below is a sample payload when a customer sends an audio file on WhatsApp to your business number.
Inbound Body
```
{
  "app": "DemoApp",
  "timestamp": 1580228104661,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAhC8Sqz6bdT95X8wgVH28wz8",
    "source": "918x98xx21x4",
    "type": "audio",
    "payload": {
      "url": "https://smapi.gupshup.io/sm/api/wamedia/demobot1/f2b80170-981d-4c16-b8be-c12b46ae3436",
      "urlExpiry": 1580832904661
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    }
  }
}
```

## Video
Below is a sample payload when a customer sends a video along with a caption on WhatsApp to your business number.
Inbound Body	
```
{
  "app": "DemoApp",
  "timestamp": 1580228336953,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAhDHMK-ctBQwqxyKoMbKcxES",
    "source": "918x98xx21x4",
    "type": "video",
    "payload": {
      "caption": "Funny video",
      "url": "https://smapi.gupshup.io/sm/api/wamedia/demobot1/9f5ff20a-d14f-47ea-b336-754756a8b950",
      "urlExpiry": 1580833136954
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    }
  }
}
```

## Document
Below is a sample payload when a customer sends a document along with a caption on WhatsApp to your business number. If no caption is sent, the “caption” key will be missing in the messageObj object

Inbound Body	
```
{
  "app": "DemoApp",
  "timestamp": 1580228523976,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAhCzqobr15BdMPcRup1fIXAJ",
    "source": "918x98xx21x4",
    "type": "file",
    "payload": {
      "caption": "Pentavalent_vaccine_Guide_for_HWs_with_answers_to_FAQs.pdf",
      "url": "https://smapi.gupshup.io/sm/api/wamedia/demobot1/1c3d7efe-b600-4560-b4d8-36a822310b53",
      "urlExpiry": 1580833323976
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    }
  }
}
```

## Location
Below is a sample payload when a customer shares their location on WhatsApp to your business number. Please note that Live Location is not a supported message type on WhatsApp Business at the moment.

Inbound Body	
```
{
  "app": "DemoApp",
  "timestamp": 1580228767338,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAhCIxTq7KXQIqby1Uo-IO7_E",
    "source": "918x98xx21x4",
    "type": "location",
    "payload": {
      "longitude": "72.8552172",
      "latitude": "19.1453658"
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    }
  }
}
```

## Contact Card
Below is a sample payload when a customer shares a contact card to your business number.
Inbound Body	
```
{
  "app": "DemoApp",
  "timestamp": 1584898884710,
  "version": 2,
  "type": "message",
  "payload": {
    "id": "ABEGkYaYVSEEAhD9cTZVyPlOGYZJOnviI7OJ",
    "source": "918698552104",
    "type": "contact",
    "payload": {
      "contacts": [
        {
          "addresses": [
            {
              "city": "Menlo Park",
              "country": "United States",
              "countryCode": "us",
              "state": "CA",
              "street": "1 Hacker Way",
              "type": "HOME",
              "zip": "94025"
            },
            {
              "city": "Menlo Park",
              "country": "United States",
              "countryCode": "us",
              "state": "CA",
              "street": "200 Jefferson Dr",
              "type": "WORK",
              "zip": "94025"
            }
          ],
          "emails": [
            {
              "email": "test@fb.com",
              "type": "WORK"
            },
            {
              "email": "test@whatsapp.com",
              "type": "WORK"
            }
          ],
          "ims": [

          ],
          "name": {
            "first_name": "Dev",
            "formatted_name": "Dev Support",
            "last_name": "Support"
          },
          "org": {
            "company": "Dev Support"
          },
          "phones": [
            {
              "phone": "+91 77383 05433",
              "type": "Mobile"
            }
          ],
          "urls": [
            {
              "url": "https://www.facebook.com",
              "type": "WORK"
            }
          ]
        }
      ]
    },
    "sender": {
      "phone": "918x98xx21x4",
      "name": "Smit",
      "country_code": "91",
      "dial_code": "8x98xx21x4"
    }
  }
}
```

# Outbound Message
This are the messages sent to a customer using the send message API

## API Endpoint
* To send a message on WhatsApp, the API request is made to this endpoint:
* https://api.gupshup.io/sm/api/v1/msg

## API Request
* Sample API Request
```
curl --location --request POST 'https://api.gupshup.io/sm/api/v1/msg' \
--header 'Cache-Control: no-cache' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--header 'apikey: 2xxc4x4xx2c94xxxc2f9xx9d43xxxx8a' \
--data-urlencode 'channel=whatsapp' \
--data-urlencode 'source=917834811114' \
--data-urlencode 'destination=918x98xx21x4' \
--data-urlencode 'message=hi' \
--data-urlencode 'src.name=DemoApp'
```

## Send a Template message
Below is a sample payload when sending a template message on WhatsApp.

API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers
```	Content-Type:
application/x-www-form-urlencoded
apikey: {{Your API Key}}
```

Request Body
```	
"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" : {
        "isHSM":"true",
        "type": "text",
        "text": "Hi John, your order is confirmed and will be delivered to you by 15 Feb"
}
```

## Send text message
Below is a sample payload when sending a text message on WhatsApp.
API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers	
```Content-Type:
application/x-www-form-urlencoded
apikey: {{Your API Key}}
```

Request Body
```	
"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" : {
        "isHSM":"false",
        "type": "text",
        "text": "Hi John, how are you?"
}
```

## Formatting Options
WhatsApp supports some formatting in text messages. To format all or part of a message, use these formatting symbols:
* Bold	Asterisk (*)	Your total is *$10.50*.
* Italics	Underscore (_)	Welcome to _WhatsApp_!	
* Strike-through	Tilde (~)	This is ~better~ best!	
* Code	Three backticks (```) 	```print 'Hello World';```

## Send Image message
Below is a sample payload when sending an image on WhatsApp.
API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers	
```
Content-Type:
application/x-www-form-urlencoded
apikey: {{Your API Key}}
```

Request Body	
```
"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" : {
        "type": "image",
        "originalUrl": "https://images.pexels.com/photos/248797/pexels-photo-248797.jpeg",
        "previewUrl": "https://images.pexels.com/photos/248797/pexels-photo-248797.jpeg",
        "caption":"Sample image"
}
```

## Send document/ file message
Below is a sample payload when sending a document / file on WhatsApp.

API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers	
```
Content-Type:
application/x-www-form-urlencoded
apikey: {{Your API Key}}
```

Request Body
```
"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" : {
        "type": "file",
        "url": "http://enterprise.smsgupshup.com/doc/GatewayAPIDoc.pdf",
        "filename": "Sample file"
}
```

## Send Audio message
Below is a sample payload when sending an audio file on WhatsApp.


API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers	
```Content-Type:
application/x-www-form-urlencoded
apikey: {{Your API Key}}
```

Request Body
```	
"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" : {
        "type": "audio",
        "url": "https://file-examples.com/wp-content/uploads/2017/11/file_example_MP3_700KB.mp3"
}
```

## Send Video message
Below is a sample payload when sending a video on WhatsApp.

API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers	
```
Content-Type:
application/x-www-form-urlencoded
apikey: {{Your API Key}}
```

Request Body
```
"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" : {
        "type": "video",
        "url":"http://clips.vorwaerts-gmbh.de/big_buck_bunny.mp4",
        "caption":"Sample video"
}
```

## Send location message
Below is a sample payload for sending static location to your end-user.


API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers
```	Content-Type: 
application/x-www-form-urlencoded
apikey: {{Your API Key}}
```
Request Body
```
"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" : {
        "type": "location",
        "longitude": 43.43,
        "latitude": 33.34,
        "name": "Name of the location",
        "address": "Postal address"
}
```

## Send Contact Card
Below is a sample payload for share a contact card with your end-user.

API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers
```
Content-Type: application/x-www-form-urlencoded
apikey: {{Your API Key}}
```
Request Body
```	"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" :{
        "type": "contact",
        "contact": {
            "addresses": [
               {
                  "city": "Menlo Park",
                  "country": "United States",
                  "countryCode": "us",
                  "state": "CA",
                  "street": "1 Hacker Way",
                  "type": "HOME",
                  "zip": "94025"
               },
               {
                  "city": "Menlo Park",
                  "country": "United States",
                  "countryCode": "us",
                  "state": "CA",
                  "street": "200 Jefferson Dr",
                  "type": "WORK",
                  "zip": "94025"
               }
            ],
            "birthday": "2012-08-18",
            "emails": [
               {
                  "email": "test@fb.com",
                  "type": "WORK" [
               },
               {
                  "email": "test@whatsapp.com",
                  "type": "WORK"
               ],
            "name": {
               "firstName": "John",
               "formattedName": "John Smith",
               "lastName": "Smith"
            },
            "org": {
               "company": "WhatsApp",
               "department": "Design",
               "title": "Manager"
            },
            "phones": [
               {
                  "phone": "+1 (940) 555-1234",
                  "type": "HOME"
               },
                  {
                     "phone": "+1 (650) 555-1234",
                     "type": "WORK",
                     "wa_id": "16505551234"
                  }
            },
            "urls": [
                     {
                     "url": "https://www.facebook.com",
                        "type": "WORK"
                     }
               ]
         }
}
```

## Send Stickers
Below is a sample payload when sending a sticker on WhatsApp.

API URL	https://api.gupshup.io/sm/api/v1/msg
Request Headers	
```Content-Type: application/x-www-form-urlencoded
apikey: {{Your API Key}}
```
Request Body
```
"channel" : "whatsapp",
"source" : "917384811114",
"destination" : "918x98xx21x4"
"src.name":"DemoApp"
"message" : {
        "type": "sticker",
        "url":"https://cdn.getstickerpack.com/storage/uploads/sticker-pack/tunes-traffic/7.png"
}
```
